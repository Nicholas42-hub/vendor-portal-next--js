<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Approval Flow</title>
    <style>
        body {
            font-family: -apple-system, system-ui, "Segoe UI", Roboto, Oxygen, Ubuntu, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            padding-top: 50px;
        }
        .sectionBlockLayout {
            display: flex;
            flex-wrap: wrap;
            margin: 0;
            padding: 8px;
            justify-content: space-between;
            gap: 20px;
        }
        .form-container {
            width: 100%;
            max-width: 800px;
        }
        .approval-flow {
            width: 100%;
            max-width: 400px;
            position: relative;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .approval-step {
            display: none;
            background-color: #fff;
            border: 2px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
        }
        .approval-step.visible {
            display: block;
        }
        .approval-step::after {
            content: 'â–¼';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: #e0e0e0;
            transition: all 0.3s ease;
        }
        .approval-step:last-child::after,
        .approval-step.no-arrow::after {
            display: none;
        }
        .approval-step.current {
            border-color: #1E88E5;
            box-shadow: 0 0 15px rgba(30,136,229,0.3);
        }
        .approval-step.current::after {
            color: #1E88E5;
        }
        .approval-step.approved {
            border-color: #4CAF50;
        }
        .approval-step.approved::after {
            color: #4CAF50;
        }
        .status-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
        .status-pending {
            background-color: #FFF9C4;
            color: #FBC02D;
        }
        .status-approved {
            background-color: #C8E6C9;
            color: #4CAF50;
        }
        .status-rejected {
            background-color: #FFCDD2;
            color: #E53935;
        }
        .status-current {
            background-color: #E3F2FD;
            color: #1E88E5;
        }
        .approval-step h3 {
            margin-top: 0;
            color: #333;
        }
        .skip-to-content {
            display: none !important;
        }
        .navbar-static-top {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 1030;
        }
        .submission {
            margin-top: 20px;
        }
        .submission input[type="submit"] {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .submission input[type="submit"]:hover {
            background-color: #45a049;
        }
        .popup {
            display: none;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .popup.open {
            display: block;
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .popup-overlay.open {
            display: block;
        }
        .popup img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 20px 0;
        }
        .popup h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }
        .popup p {
            font-size: 16px;
            color: #555;
            margin-bottom: 30px;
        }
        .popup button {
            width: 100px;
            padding: 10px;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .popup button.btn-yes {
            background-color: #4CAF50;
        }
        .popup button.btn-OK {
            background-color: #4CAF50;
        }
        .popup button.btn-no {
            background-color: #FF0000;
        }
        .popup .button-container .button-container-ok .delete-button-container{
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fff;
        }
        .form .subtitle {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        .form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form input[type="text"],
        .form input[type="email"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .button-container .delete-button-container{
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .button-container-resubmit {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .approve-btn, .decline-btn {
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            width: 48%;
        }
        .approve-btn {
            background-color: #4CAF50;
            color: white;
        }
        .decline-btn {
            background-color: #f44336;
            color: white;
        }
        .approve-btn:hover {
            background-color: #45a049;
        }
        .decline-btn:hover {
            background-color: #d32f2f;
        }
        #declineCommentContainer {
            margin-top: 20px;
        }
        #declineComment {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .status-declined {
            background-color: #FFCDD2;
            color: #E53935;
        }
        .approval-step.declined {
            border-color: #E53935;
        }
        .resubmit-btn {
            background-color: #2196F3;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        .delete-btn {
            background-color: #E53935;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        .delete-btn:hover {
            background-color: #E53938;
        }
        .resubmit-btn:hover {
            background-color: #1E88E5;
        }
        @media (max-width: 600px) {
            .popup {
                width: 90%;
            }
            .approval-flow {
                max-width: 100%;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="i6thd" class="row sectionBlockLayout text-left">
        <div class="form-container form-style-6">
            <form id="VendorOnboardingForm">
                <legend>Vendor Onboarding Form</legend>
                <h2 class="subtitle">Supplier Details</h2>
                <label for="trading_name">Trading Name (if different to Business Name):<span class="required-field">*</span></label>
                <input type="text" id="trading_name" name="trading_name" readonly>
                <div id="au-field" class="au-field">
                    <label for="abn">Australian Business Number (ABN):<span class="required-field">*</span></label>
                    <input type="text" id="abn" name="abn" readonly>
                </div>
                <div id='nz-field' class="nz-field hidden">
                    <label for="gst">New Zealand Goods & Services Tax Number (GST):<span class="required-field">*</span></label>
                    <input type="text" id="gst" name="gst" inputmode="numeric" required>
                </div>

                <label for="website">Website:</label>
                <input type="text" id="website" name="website" readonly>
                <label for="postal_address">Postal Address:<span class="required-field">*</span></label>
                <input type="text" id="postal_address" name="postal_address" readonly>
                <label for="city">City:<span class="required-field">*</span></label>
                <input type="text" id="city" name="city" readonly>
                <label for="state">State:<span class="required-field">*</span></label>
                <input type="text" id="state" name="state" readonly>
                <label for="postcode">Postcode:<span class="required-field">*</span></label>
                <input type="text" id="postcode" name="postcode" readonly>
                <label for="accounts_contact">Accounts Contact:<span class="required-field">*</span></label>
                <input type="text" id="accounts_contact" name="accounts_contact" readonly>
                <label for="telephone">Telephone:<span class="required-field">*</span></label>
                <input type="text" id="telephone" name="telephone" readonly>
                <label for="po_email">PO Email:<span class="required-field">*</span></label>
                <input type="email" id="po_email" name="po_email" readonly>
                <label for="invoice_currency">Invoice Currency:<span class="required-field">*</span></label>
                <input type="text" id="invoice_currency" name="invoice_currency" readonly>
                
                <h2 class="subtitle">Banking Details</h2>
                <div id="banking-details" class="au-field">
                    <label for="bank_name">Bank Name:<span class="required-field">*</span></label>
                    <input type="text" id="bank_name" name="bank_name" readonly>
                    <label for="bsb">BSB:<span class="required-field">*</span></label>
                    <input type="text" id="bsb" name="bsb" readonly>
                    <label for="account">Account Number:<span class="required-field">*</span></label>
                    <input type="text" id="account" name="account" readonly>
                </div>
                <div id="nz-field-banking" class="nz-field hidden">
                    <label for="bank_name">Bank Name:<span class="required-field">*</span></label>
                    <input type="text" id="nz_bank_name" name="nz_bank_name" readonly>
                    <label for="bsb">BSB:<span class="required-field">*</span></label>
                    <input type="text" id="nz_BSB" name="nz_BSB" readonly>
                    <label for="account">Account Number:<span class="required-field">*</span></label>
                    <input type="text" id="nz_account" name="nz_account" readonly>
                </div>
            </form>
            
            <form id="Tradingterm" class="form" style="display: none;">
                <h2 class="subtitle">Trading Terms</h2>
            <div id="trading_terms_container">
                <label for="BU">Primary Trading Business Unit:</label>
                <input type="text" id="BU" name="BU" readonly>
                <div class="term-field" id="purchase_type_field">
                        <label for="purchase_type">One Time Purchase / Repeat:</label>
                        <input type="text" id="purchase_type" name="purchase_type" readonly>
                </div>
                <!-- <div class="term-field" id="start_date_field">
                        <label for="start_date">Start date of Account Form Trading Terms:</label>
                        <input type="text" id="start_date" name="start_date" readonly>
                </div> -->
            </div>

            </form>
            
            <div id="Supplyterm" class="form" style="display: none;">
                <h2 class="subtitle">Supply Terms</h2>
                <div id="supply_terms_container">
                    <div class="term-field" id="delivery_field">
                        <label for="delivery">Delivery:</label>
                        <input type="text" id="delivery" name="delivery" readonly>
                    </div>
                    <div class="term-field" id="barcode_field">
                        <label for="barcode">Barcode:</label>
                        <input type="text" id="barcode" name="barcode" readonly>
                    </div>
                    <div class="term-field" id="delivery_notice_field">
                        <label for="delivery_notice">Delivery Notice (Lead Time):</label>
                        <input type="text" id="delivery_notice" name="delivery_notice" readonly>
                    </div>
                    <div class="term-field" id="min_order_field">
                        <label for="min_order_value">Minimum Order Value:</label>
                        <input type="text" id="min_order_value" name="min_order_value" readonly>
                    </div>
                    <div class="term-field" id="max_order_field">
                        <label for="max_order_value">Maximum Order Value:</label>
                        <input type="text" id="max_order_value" name="max_order_value" readonly>
                    </div>
                    <div class="term-field" id="comments_field">
                        <label for="other_comments">Other Comments:</label>
                        <textarea id="other_comments" name="other_comments" readonly></textarea>
                    </div>
                </div>
            </div>
            
            <div id="Financialterms" class="form" style="display: none;">
                <h2 class="subtitle">Financial Terms</h2>
                <div id="financial_terms_container">
                    <div class="term-field" id="payment_terms_field">
                        <label for="payment_terms">Payment Terms:</label>
                        <input type="text" id="payment_terms" name="payment_terms" readonly>
                    </div>
                    <div class="term-field" id="gross_margin_field">
                        <label for="gross_margin">Gross Margin:</label>
                        <input type="text" id="gross_margin" name="gross_margin" readonly>
                    </div>
                    <div class="term-field" id="agreed_discount_field">
                        <label for="agreed_discount">Agreed Discount:</label>
                        <input type="text" id="agreed_discount" name="agreed_discount" readonly>
                    </div>
                    <div class="term-field" id="invoice_discount_field">
                        <label for="invoice_discount">Invoice Discount:</label>
                        <input type="text" id="invoice_discount" name="invoice_discount" readonly>
                    </div>
                    <div class="term-field" id="settlement_discount_field">
                        <label for="settlement_discount">Settlement Discount:</label>
                        <input type="text" id="settlement_discount" name="settlement_discount" readonly>
                    </div>
                    <div class="term-field" id="flat_rebate_field">
                        <label for="flat_rebate">Flat Rebate:</label>
                        <input type="text" id="flat_rebate" name="flat_rebate" readonly>
                    </div>
                    <div class="term-field" id="growth_rebate_field">
                        <label for="growth_rebate">Growth Rebate:</label>
                        <input type="text" id="growth_rebate" name="growth_rebate" readonly>
                    </div>
                    <div class="term-field" id="marketing_rebate_field">
                        <label for="marketing_rebate">Marketing Rebate:</label>
                        <input type="text" id="marketing_rebate" name="marketing_rebate" readonly>
                    </div>
                    <div class="term-field" id="promotional_fund_field">
                        <label for="promotional_fund">Promotional Fund:</label>
                        <input type="text" id="promotional_fund" name="promotional_fund" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="approval-flow form-style-6">
            <legend>Approval Flow</legend>
            <div id="approvalSteps">
                <div id="step1" class="approval-step">
                    <h3>Step 1: Manager Approval</h3>
                    <p>
                        <span>Status:</span>
                        <span id="step1Status" class="status-indicator status-pending">Pending</span>
                    </p>
                </div>
                <div id="step2" class="approval-step">
                    <h3>Step 2: CFO Approval</h3>
                    <p>
                        <span>Status:</span>
                        <span id="step2Status" class="status-indicator status-pending">Pending</span>
                    </p>
                </div>
                <div id="step3" class="approval-step">
                    <h3>Step 3: Exco Approval</h3>
                    <p>
                        <span>Status:</span>
                        <span id="step3Status" class="status-indicator status-pending">Pending</span>
                    </p>
                </div>
                <div id="step4" class="approval-step no-arrow">
                    <h3>Step 4: Completed</h3>
                    <p>
                        <span>Status:</span>
                        <span id="step4Status" class="status-indicator status-pending">Pending</span>
                    </p>
                </div>
            </div>
            <div id="declineMessage" style="display: none;">
                <h3>Declined</h3>
                <p>Reason for decline:</p>
                <p id="declineReason"></p>
            </div>
            <div class="button-container">
                <button type="button" class="approve-btn" onclick="handleSubmit(event)">Approve</button>
                <button type="button" class="decline-btn" onclick="handleDecline(event)">Decline</button>
            </div>
            <button type="button" class="resubmit-btn" onclick="handleResubmit(event)" style="display: none;">Re-submit</button>
            <button type="button" class="delete-btn" onclick="handledelete(event)" style="display: none;">Delete</button>
        </div>
    </div>

    <!-- Confirmation Popup -->
    <div id="confirmPopup" class="popup">
        <h2>Would you like to proceed?</h2>
        <p>Are you sure you want to approve this vendor?</p>
        <div class="button-container">
            <button type="button" class="btn-yes" onclick="proceedSubmit()">Yes</button>
            <button type="button" class="btn-no" onclick="closeConfirmPopup()">No</button>
        </div>
    </div>
    
    <!-- Decline Confirmation Popup -->
    <div id="declinePopup" class="popup">
        <h2>Are you sure you want to decline?</h2>
        <div id="declineCommentContainer">
            <label for="declineComment">Please provide a reason:</label>
            <textarea id="declineComment" placeholder="Enter your comment here..."></textarea>
        </div>
        <div class="-delete-button-container">
            <button type="button" class="btn-yes" onclick="confirmDecline()">Yes</button>
            <button type="button" class="btn-no" onclick="closeDeclinePopup()">No</button>
        </div>
    </div>
    <!--Delete Confirmation Popup-->
    <div id="deletePopup" class="popup">
        <h2>Are you sure you want to DELETE this request?</h2>
        <div class="delete-button-container">
            <button type="button" class="btn-yes" onclick="confirmdelete()">Yes</button>
            <button type="button" class="btn-no" onclick="closeDeletePopup()">No</button>
        </div>
    </div>
    <!-- Thank You Popup -->
    <div id="thankYouPopup" class="popup">
        <h2>Thank you!</h2>
        <p>The request has been approved. Thanks!</p>
        <div class="button-container-ok">
            <button type="button" class="btn-OK" onclick="closeThankYouPopup_vendor_setup()">OK</button>
        </div>
    </div>
    
    <!-- Overlay -->
    <div id="overlay" class="popup-overlay"></div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
    (function(webapi, $){
        function safeAjax(ajaxOptions) {
            var deferredAjax = $.Deferred();
            shell.getTokenDeferred().done(function (token) {
                if (!ajaxOptions.headers) {
                    $.extend(ajaxOptions, {
                        headers: {
                            "__RequestVerificationToken": token
                        }
                    }); 
                } else {
                    ajaxOptions.headers["__RequestVerificationToken"] = token;
                }
                $.ajax(ajaxOptions)
                    .done(function(data, textStatus, jqXHR) {
                        validateLoginSession(data, textStatus, jqXHR, deferredAjax.resolve);
                    }).fail(deferredAjax.reject);
            }).fail(function () {
                deferredAjax.rejectWith(this, arguments);
            });
            return deferredAjax.promise();	
        }
        webapi.safeAjax = safeAjax;
    })(window.webapi = window.webapi || {}, jQuery);

    var currentVendorId;
    var requiresCFOApproval = false;

    $(document).ready(function() {
        console.log("Document ready");
        var urlParams = new URLSearchParams(window.location.search);
        var email = urlParams.get('email');

        if (email) {
            console.log("Email found in URL:", email);
            fetchVendorData(email);
        } else {
            console.error("No email provided in the URL");
            alert("No email provided in the URL.");
        }
    });

    function fetchVendorData(email) {
    console.log("Fetching vendor data for email:", email);
    webapi.safeAjax({
        type: "GET",
        url: `/_api/contacts?$filter=emailaddress1 eq '${encodeURIComponent(email)}'`,
        contentType: "application/json",
        headers: {
            "Prefer": "odata.include-annotations=*"
        },
        success: function (data, textStatus, xhr) {
            console.log("Vendor data received:", data);
            if (data && data.value && data.value.length > 0) {
                var vendor = data.value[0];
                requiresCFOApproval = ['1 DAY', '10 DAYS', '13 DAYS', '14 DAYS', '15 DAYS', '20 DAYS', '21 DAYS'].includes(vendor.crb7c_paymentterms);
                
                // Handle region-specific fields based on description
                const description = vendor.description;
                handleRegionSpecificFields(description);

                if (vendor.crb7c_parentvendor) {
                    // If parent vendor exists, fetch parent vendor data
                    webapi.safeAjax({
                        type: "GET",
                        url: `/_api/contacts?$filter=emailaddress1 eq '${encodeURIComponent(vendor.crb7c_parentvendor)}'`,
                        contentType: "application/json",
                        headers: {
                            "Prefer": "odata.include-annotations=*"
                        },
                        success: function (parentData, parentTextStatus, parentXhr) {
                            if (parentData && parentData.value && parentData.value.length > 0) {
                                var parentVendor = parentData.value[0];
                                // Use parent vendor data for supplier form and vendor data for form
                                populate_supplierformfields(parentVendor);
                                populateFormFields(vendor);
                                updateApprovalFlow(vendor.crb7c_statuscode);
                            } else {
                                console.error("No parent vendor found with email:", vendor.crb7c_parentvendor);
                                alert("Error: Parent vendor not found.");
                            }
                        },
                        error: function (parentXhr, parentTextStatus, parentErrorThrown) {
                            console.error("Error fetching parent vendor data:", parentErrorThrown);
                            alert("Error fetching parent vendor data. Please try again later.");
                        }
                    });
                } else {
                    // If no parent vendor, use the same vendor data for both forms
                    populate_supplierformfields(vendor);
                    populateFormFields(vendor);
                    updateApprovalFlow(vendor.crb7c_statuscode);
                }
            } else {
                console.error("No vendor found with the provided email:", email);
                alert("No vendor found with the provided email.");
            }
        },
        error: function (xhr, textStatus, errorThrown) {
            console.error("Error fetching vendor data:", errorThrown);
            alert("Error fetching vendor data. Please try again later.");
        }
    });
}
    function populate_supplierformfields(vendor){
        console.log("Populating form fields with vendor data:", vendor);
        $('#BU').val(vendor.crb7c_primarytradingbusinessunit);
        $('#trading_name').val(vendor.crb7c_tradingname);
        $('#abn').val(vendor.crb7c_abn);
        $('#gst').val(vendor.crb7c_gst);
        $('#website').val(vendor.websiteurl);
        $('#postal_address').val(vendor.address1_postofficebox);
        $('#city').val(vendor.address1_city);
        $('#state').val(vendor.address1_stateorprovince);
        $('#postcode').val(vendor.address1_postalcode);
        $('#accounts_contact').val(vendor.crb7c_accountcontact);
        $('#telephone').val(vendor.address1_telephone2);
        $('#po_email').val(vendor.emailaddress1);
        $('#invoice_currency').val(vendor.crb7c_invoicecurrency);
        $('#bank_name').val(vendor.crb7c_bankname);
        $('#bsb').val(vendor.crb7c_aubsb);
        $('#account').val(vendor.crb7c_auaccount);
        $('#nz_BSB').val(vendor.crb7c_nzbsb),
        $('#nz_account').val(vendor.crb7c_nzaccount)
    }

    function populateFormFields(vendor) {

        if (vendor.crb7c_primarytradingbusinessunit) {
            $('#purchase_type').val(vendor.crb7c_purchasetype);
            $('#Tradingterm').show();
        } else {
            $('#Tradingterm').hide();
        }

        if (vendor.crb7c_delivery_notice || vendor.crb7c_barcode || vendor.crb7c_max_order_value || vendor.crb7c_min_order_value) {
            $('#delivery_notice').val(vendor.crb7c_delivery_notice);
            $('#barcode').val(vendor.crb7c_barcode);
            $('#max_order_value').val(vendor.crb7c_max_order_value);
            $('#min_order_value').val(vendor.crb7c_min_order_value);
            $('#Supplyterm').show();

        } else {
            $('#Supplyterm').hide();
        }

        if (vendor.crb7c_paymentterms || vendor.crb7c_exclusivesupply) {
            $('#payment_terms').val(vendor.crb7c_paymentterms);
            $('#exclusive_supply_yn').val(vendor.crb7c_exclusivesupply);
            $('#sale_or_return_yn').val(vendor.crb7c_salesorreturn);
            $('#sale_or_exchange_yn').val(vendor.crb7c_salesorexchange);
            $('#gross_margin').val(vendor.crb7c_grossmargin);
            $('#agreed_discount').val(vendor.crb7c_agreeddiscount);
            $('#invoice_discount').val(vendor.crb7c_invoicediscount);
            $('#settlement_discount').val(vendor.crb7c_settlementdiscount);
            $('#settlement_discount_days').val(vendor.crb7c_settlementdiscountdays);
            $('#flat_rebate').val(vendor.crb7c_flatrebate);
            $('#growth_rebate').val(vendor.crb7c_growthrebate);
            $('#marketing_rebate').val(vendor.crb7c_marketingrebate);
            $('#promotional_fund').val(vendor.crb7c_promotionalfund);
            $('#Financialterms').show();

        } else {
            $('#Financialterms').hide();
        }

        if (vendor.crb7c_abn) {
            $('#au-field').show();
            $('#nz-field').hide();
        } else if (vendor.crb7c_gst) {
            $('#nz-field').show();
            $('#au-field').hide();
        }

        console.log("Form fields populated. Current status:", vendor.crb7c_statuscode);
    }

    function updateStatus(elementId, status, isCurrent, isApproved) {
        var statusElement = $('#' + elementId);
        var stepElement = statusElement.closest('.approval-step');
        
        statusElement.text(status);
        statusElement.removeClass('status-pending status-approved status-current');
        stepElement.removeClass('current approved');
        
        if (isApproved) {
            statusElement.addClass('status-approved');
            stepElement.addClass('approved');
        } else if (isCurrent) {
            statusElement.addClass('status-current');
            stepElement.addClass('current');
        } else {
            statusElement.addClass('status-pending');
        }
    }

    function updateApprovalFlow(statusCode) {
        console.log("Updating approval flow with status:", statusCode);
        var steps = [
            { id: 'step1', status: 'Pending Manager Approval', label: 'Manager Approval' },
            { id: 'step2', status: 'Pending CFO Approval', label: 'CFO Approval' },
            { id: 'step3', status: 'Pending Exco Approval', label: 'Exco Approval' },
            { id: 'step4', status: 'Creation approved', label: 'Completed' }
        ];

        if (!requiresCFOApproval) {
            steps.splice(1, 1);
        }

        if (statusCode === 'Declined') {
            $('#approvalSteps').hide();
            $('#declineMessage').show();
            $('.button-container').hide();
            $('.resubmit-btn').show();
            $('.delete-btn').hide();
            makeFieldsEditable();
            fetchDeclineComment();
        } else if (statusCode === 'Invitation sent') { 
            $('#approvalSteps').hide();
            $('#declineMessage').hide();
            $('.button-container').hide();
            $('.resubmit-btn').hide();
            $('.delete-btn').show();
        }else {
            $('#approvalSteps').show();
            $('#declineMessage').hide();
            $('.resubmit-btn').hide();
            $('.delete-btn').hide();
            makeFieldsReadOnly();

            var currentStepIndex = steps.findIndex(step => step.status === statusCode);
            if (currentStepIndex === -1) {
                currentStepIndex = 0;
                statusCode = steps[0].status;
            }

            steps.forEach((step, index) => {
                var stepElement = $('#' + step.id);
                stepElement.show();
                stepElement.find('h3').text(`Step ${index + 1}: ${step.label}`);

                var isApproved = index < currentStepIndex;
                var isCurrent = index === currentStepIndex;
                var status = isApproved ? 'Approved' : (isCurrent ? statusCode : 'Pending');
                updateStatus(step.id + 'Status', status, isCurrent, isApproved);

                if (index > currentStepIndex) {
                    stepElement.hide();
                }
            });

            if (statusCode === 'Creation approved') {
                $('.button-container').hide();
                $('#step4')
                    .addClass('approved')
                    .css('border-color', '#4CAF50');
                $('#step4').addClass('no-arrow');
                $('#step4Status')
                    .addClass('status-approved')
                    .removeClass('status-current status-pending');
            } else {
                $('.button-container').show();
            }

            $('.approval-step:visible').removeClass('no-arrow').last().addClass('no-arrow');
        }

        approvervalidate(statusCode);
    }

    function makeFieldsEditable() {
        $('#VendorOnboardingForm input, #Tradingterm input, #Supplyterm input, #Financialterms input').prop('readonly', false);
    }

    function makeFieldsReadOnly() {
        $('#VendorOnboardingForm input, #Tradingterm input, #Supplyterm input, #Financialterms input').prop('readonly', true);
    }

    function fetchDeclineComment() {
        var urlParams = new URLSearchParams(window.location.search);
        var email = urlParams.get('email');

        webapi.safeAjax({
            type: "GET",
            url: `/_api/contacts?$select=crb7c_approvalcomment&$filter=emailaddress1 eq '${encodeURIComponent(email)}'`,
            contentType: "application/json",
            success: function(data) {
                if (data && data.value && data.value.length > 0) {
                    var comment = data.value[0].crb7c_approvalcomment;
                    $('#declineReason').text(comment || "No reason provided");
                } else {
                    $('#declineReason').text("No decline comment found");
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                console.error("Error fetching decline comment:", errorThrown);
                $('#declineReason').text("Error fetching decline comment");
            }
        });
    }

    function handleResubmit() {
    var urlParams = new URLSearchParams(window.location.search);
    var email = urlParams.get('email');

    if (!email) {
        console.error("No email provided in the URL");
        alert("Error: Unable to resubmit. Missing email parameter.");
        return;
    }

    // First, fetch the contact record to get the contactid
    webapi.safeAjax({
        type: "GET",
        url: `/_api/contacts?$select=contactid&$filter=emailaddress1 eq '${encodeURIComponent(email)}'`,
        contentType: "application/json",
        success: function(data) {
            if (data && data.value && data.value.length > 0) {
                var contactId = data.value[0].contactid;
                resubmitVendor(contactId);
            } else {
                console.error("No contact found with the provided email");
                alert("Error: Unable to find the contact. Please try again.");
            }
        },
        error: function(xhr, textStatus, errorThrown) {
            console.error("Error fetching contact:", errorThrown);
            alert("Error: Unable to fetch contact information. Please try again.");
        }
    });
}

function resubmitVendor(contactId) {
    // Fetch the current contact data
    webapi.safeAjax({
        type: "GET",
        url: `/_api/contacts(${contactId})`,
        contentType: "application/json",
        success: function(contactData) {
            var storedStatus = contactData.crb7c_statuscode_record || 'Pending Manager Approval';
            var businessUnit = contactData.crb7c_primarytradingbusinessunit;

            // Fetch approvers data
            webapi.safeAjax({
                type: "GET",
                url: `/_api/crb7c_approverses?$select=crb7c_approversid,crb7c_approver1,crb7c_approver2,crb7c_approver3,crb7c_businessunit&$filter=crb7c_businessunit eq '${encodeURIComponent(businessUnit)}'`,
                contentType: "application/json",
                success: function(approversData) {
                    if (approversData && approversData.value && approversData.value.length > 0) {
                        var approvers = approversData.value[0];
                        var formData = {
                            crb7c_statuscode: storedStatus,
                            crb7c_approvalcomment: null,
                            crb7c_statusupdatetime: new Date().toISOString(),
                            crb7c_currentapprover: contactData.crb7c_createdbyemail,
                            crb7c_currentapprovername: contactData.adx_createdbyusername,
                            crb7c_tradingname: $('#trading_name').val(),
                            crb7c_abn: $('#abn').val(),
                            crb7c_gst: $('#gst').val(),
                            websiteurl: $('#website').val(),
                            address1_postofficebox: $('#postal_address').val(),
                            address1_city: $('#city').val(),
                            crb7c_statuscode_record: 'Declined',
                            address1_stateorprovince: $('#state').val(),
                            address1_postalcode: $('#postcode').val(),
                            crb7c_accountscontact: $('#accounts_contact').val(),
                            address1_telephone2: $('#telephone').val(),
                            emailaddress1: $('#po_email').val(),
                            crb7c_invoicecurrency: $('#invoice_currency').val(),
                            crb7c_bankname: $('#bank_name').val(),
                            crb7c_bsb: $('#bsb').val(),
                            crb7c_accountnumber: $('#account').val(),
                            crb7c_primarytradingbusinessunit: $('#purchase_type').val(),
                            crb7c_delivery_notice: $('#delivery_notice').val(),
                            crb7c_max_order_value: $('#max_order_value').val(),
                            crb7c_min_order_value: $('#min_order_value').val()
                        };

                        // Set next approver based on the resumed status
                        switch(storedStatus) {
                            case 'Pending Manager Approval':
                                formData.crb7c_nextapprover = approvers.crb7c_approver1;
                                formData.crb7c_nextapprovername = approvers.crb7c_approver1_name;
                                break;
                            case 'Pending CFO Approval':
                                formData.crb7c_nextapprover = approvers.crb7c_approver2;
                                formData.crb7c_nextapprovername = approvers.crb7c_approver2_name;
                                break;
                            case 'Pending Exco Approval':
                                formData.crb7c_nextapprover = approvers.crb7c_approver3;
                                formData.crb7c_nextapprovername = approvers.crb7c_approver3_name;
                                break;
                            // case 'Creation approved':
                            // formData.crb7c_nextapprover = contactData.emailaddress1;
                            // formData.crb7c_nextapprovername = contactData.lastname;
                            default:
                                formData.crb7c_nextapprover = approvers.crb7c_approver1;
                                formData.crb7c_nextapprovername = approvers.crb7c_approver1_name;
                        }

                        // Update the contact with all the new data in a single operation
                        webapi.safeAjax({
                            type: "PATCH",
                            url: `/_api/contacts(${contactId})`,
                            contentType: "application/json",
                            data: JSON.stringify(formData),
                            success: function(updateData, textStatus, xhr) {
                                console.log("Vendor resubmitted successfully");
                                updateApprovalFlow(storedStatus);
                                openThankYouPopup("Your vendor application has been resubmitted successfully.");
                            },
                            error: function(xhr, textStatus, errorThrown) {
                                console.error("Error resubmitting vendor:", errorThrown);
                                alert("Error: Unable to resubmit vendor application. Please try again.");
                            }
                        });
                    } else {
                        console.error("No approvers found for the business unit");
                        alert("Error: Unable to find approvers. Please try again.");
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.error("Error fetching approvers data:", errorThrown);
                    alert("Error: Unable to fetch approver information. Please try again.");
                }
            });
        },
        error: function(xhr, textStatus, errorThrown) {
            console.error("Error fetching contact data:", errorThrown);
            alert("Error: Unable to fetch contact data. Please try again.");
        }
    });
}

    function handleSubmit(event) {
        event.preventDefault();
        openConfirmPopup();
    }

    function openConfirmPopup() {
        $('#confirmPopup').addClass('open');
        $('#overlay').addClass('open');
    }

    function closeConfirmPopup() {
        $('#confirmPopup').removeClass('open');
        $('#overlay').removeClass('open');
    }

    function proceedSubmit() {
        closeConfirmPopup();
        updateVendorStatus();
    }

    function openThankYouPopup(message) {
        $('#thankYouPopup p').text(message || "The request has been approved. Thanks!");
        $('#thankYouPopup').addClass('open');
        $('#overlay').addClass('open');
    }

    function closeThankYouPopup_vendor_setup() {
        $('#thankYouPopup').removeClass('open');
        $('#overlay').removeClass('open');
    }

    function updateVendorStatus() {
        var currentStatus = getCurrentStatus();
        var newStatus = getNextStatus(currentStatus);
        
        if (newStatus) {
            updateStatusInDataverse(newStatus);
        } else {
            alert("No further approval steps available.");
        }
    }

    function getCurrentStatus() {
        var steps = ['step1Status', 'step2Status', 'step3Status', 'step4Status'];
        if (!requiresCFOApproval) {
            steps.splice(1, 1);
        }

        for (var i = steps.length - 1; i >= 0; i--) {
            var status = $('#' + steps[i]).text();
            if (status !== 'Pending') {
                return status;
            }
        }
        return 'Pending Manager Approval';
    }

    function getNextStatus(currentStatus) {
        var statusFlow = [
            'Pending Manager Approval',
            'Pending CFO Approval',
            'Pending Exco Approval',
            'Creation approved'
        ];
        if (!requiresCFOApproval) {
            statusFlow.splice(1, 1);
        }

        var currentIndex = statusFlow.indexOf(currentStatus);
        if (currentIndex < statusFlow.length - 1) {
            return statusFlow[currentIndex + 1];
        }
        return null;
    }

    function updateStatusInDataverse(newStatus) {
    var record = {
        crb7c_statuscode: newStatus
    };

    var urlParams = new URLSearchParams(window.location.search);
    var email = urlParams.get('email');
    var currentUserEmail = "{{ user.emailaddress1 }}";

    if (!email) {
        console.error("No email provided in the URL");
        alert("Error: Unable to update status. Missing email parameter.");
        return;
    }

    webapi.safeAjax({
        type: "GET",
        url: `/_api/contacts?$filter=emailaddress1 eq '${encodeURIComponent(email)}'`,
        contentType: "application/json",
        headers: {
            "Prefer": "odata.include-annotations=*"
        },
        success: function (vendorData) {
            if (vendorData && vendorData.value && vendorData.value.length > 0) {
                var vendor = vendorData.value[0];
                var businessUnit = vendor.crb7c_primarytradingbusinessunit;

                if (!businessUnit) {
                    console.error("Business Unit is not set");
                    alert("Error: Unable to update status. Business Unit is not set.");
                    return;
                }

                webapi.safeAjax({
                    type: "GET",
                    url: `/_api/crb7c_approverses?$select=crb7c_approversid,crb7c_approver1,crb7c_approver2,crb7c_approver3,crb7c_businessunit&$filter=crb7c_businessunit eq '${encodeURIComponent(businessUnit)}'`,
                    contentType: "application/json",
                    headers: {
                        "Prefer": "odata.include-annotations=*"
                    },
                    success: function (approversData) {
                        if (approversData && approversData.value && approversData.value.length > 0) {
                            var approvers = approversData.value[0];
                            
                            // Function to get approver name
                            function getApproverName(email) {
                                return new Promise((resolve, reject) => {
                                    webapi.safeAjax({
                                        type: "GET",
                                        url: `/_api/contacts?$select=lastname&$filter=emailaddress1 eq '${encodeURIComponent(email)}'`,
                                        contentType: "application/json",
                                        success: function(data) {
                                            if (data && data.value && data.value.length > 0) {
                                                resolve(data.value[0].lastname);
                                            } else {
                                                resolve(null);
                                            }
                                        },
                                        error: function() {
                                            resolve(null);
                                        }
                                    });
                                });
                            }

                            // Prepare promises for current and next approver names
                            let currentApproverNamePromise = getApproverName(currentUserEmail);
                            let nextApproverNamePromise;

                            switch(newStatus) {
                                case 'Pending CFO Approval':
                                    record.crb7c_currentapprover = currentUserEmail;
                                    record.crb7c_nextapprover = approvers.crb7c_approver2;
                                    record.crb7c_statusupdatetime = new Date().toISOString();
                                    nextApproverNamePromise = getApproverName(approvers.crb7c_approver2);
                                    record.crb7c_statuscode_record =  null;
                                    break;
                                case 'Pending Exco Approval':
                                    record.crb7c_currentapprover = currentUserEmail;
                                    record.crb7c_nextapprover = approvers.crb7c_approver3;
                                    record.crb7c_statusupdatetime = new Date().toISOString();
                                    nextApproverNamePromise = getApproverName(approvers.crb7c_approver3);
                                    record.crb7c_statuscode_record =  null;
                                    break;
                                case 'Creation approved':
                                    record.crb7c_currentapprover = currentUserEmail;
                                    record.crb7c_nextapprover = email;
                                    record.crb7c_statusupdatetime = null;
                                    record.crb7c_vendorsetupstatus = 'No';
                                    nextApproverNamePromise = getApproverName(email);
                                    record.crb7c_statuscode_record =  null;
                                    break;
                                default:
                                    record.crb7c_currentapprover = currentUserEmail;
                                    record.crb7c_nextapprover = requiresCFOApproval ? approvers.crb7c_approver2 : approvers.crb7c_approver3;
                                    record.crb7c_statusupdatetime = new Date().toISOString();
                                    nextApproverNamePromise = getApproverName(record.crb7c_nextapprover);
                                    record.crb7c_statuscode_record =  null;
                            }

                            // Wait for both approver names to be fetched
                            Promise.all([currentApproverNamePromise, nextApproverNamePromise])
                                .then(([currentApproverName, nextApproverName]) => {
                                    record.crb7c_currentapprovername = currentApproverName;
                                    record.crb7c_nextapprovername = nextApproverName;

                                    // Update the record
                                    webapi.safeAjax({
                                        type: "PATCH",
                                        contentType: "application/json",
                                        url: `/_api/contacts(${vendor.contactid})`,
                                        data: JSON.stringify(record),
                                        success: function (data, textStatus, xhr) {
                                            console.log("Record updated");
                                            updateApprovalFlow(newStatus);
                                            openThankYouPopup();
                                        },
                                        error: function (xhr, textStatus, errorThrown) {
                                            console.error("Error updating status:", xhr.responseJSON || xhr.responseText);
                                            alert("Error updating status. Please try again.");
                                        }
                                    });
                                });
                        } else {
                            console.error("No approvers found for the business unit");
                            alert("Error: Unable to find approvers. Please try again.");
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.error("Error fetching approvers:", errorThrown);
                        alert("Error: Unable to fetch approver information. Please try again.");
                    }
                });
            } else {
                console.log("No vendor found with the provided email");
                alert("Error: Unable to find vendor information. Please try again.");
            }
        },
        error: function (xhr, textStatus, errorThrown) {
            console.error("Error fetching vendor data:", errorThrown);
            alert("Error: Unable to fetch vendor information. Please try again.");
        }
    });
}

    function approvervalidate(statusCode) {
        var urlParams = new URLSearchParams(window.location.search);
        var email = urlParams.get('email');
        var currentUserEmail = "{{ user.emailaddress1 }}";

        console.log("Approver Validation - Status Code:", statusCode);

        if (email) {
            webapi.safeAjax({
                type: "GET",
                url: `/_api/contacts?$filter=emailaddress1 eq '${encodeURIComponent(email)}'`,
                contentType: "application/json",
                headers: {
                    "Prefer": "odata.include-annotations=*"
                },
                success: function (vendorData, vendorTextStatus, vendorXhr) {
                    if (vendorData && vendorData.value && vendorData.value.length > 0) {
                        var vendor = vendorData.value[0];
                        var businessUnit = vendor.crb7c_primarytradingbusinessunit;
                        $('#BU').val(businessUnit);
                        console.log("Business Unit set to:", businessUnit);

                        if (!businessUnit) {
                            console.error("Business Unit is not set");
                            $('.button-container').hide();
                            return;
                        }

                        webapi.safeAjax({
                            type: "GET",
                            url: `/_api/crb7c_approverses?$select=crb7c_approversid,crb7c_approver1,crb7c_approver2,crb7c_approver3,crb7c_businessunit&$filter=crb7c_businessunit eq '${encodeURIComponent(businessUnit)}'`,
                            contentType: "application/json",
                            headers: {
                                "Prefer": "odata.include-annotations=*"
                            },
                            success: function (approversData, approversTextStatus, approversXhr) {
                                console.log("Approvers data:", approversData);
                                if (approversData && approversData.value && approversData.value.length > 0) {
                                    var approvers = approversData.value[0];
                                    var canApprove = false;

                                    switch(statusCode) {
                                        case 'Pending Manager Approval':
                                            canApprove = (approvers.crb7c_approver1 === currentUserEmail);
                                            break;
                                        case 'Pending CFO Approval':
                                            canApprove = requiresCFOApproval && (approvers.crb7c_approver2 === currentUserEmail);
                                            break;
                                        case 'Pending Exco Approval':
                                            canApprove = (approvers.crb7c_approver3 === currentUserEmail);
                                            break;
                                        default:
                                            console.log("Unknown status code:", statusCode);
                                            break;
                                    }

                                    console.log("Can Approve:", canApprove);
                                    if (canApprove) {
                                        $('.button-container').show();
                                    } else {
                                        $('.button-container').hide();
                                    }
                                } else {
                                    console.log("No approvers found for the business unit:", businessUnit);
                                    $('.button-container').hide();
                                }
                            },
                            error: function (approversXhr, approversTextStatus, approversErrorThrown) {
                                console.error("Error fetching approvers:", approversErrorThrown);
                                $('.button-container').hide();
                            }
                        });
                    } else {
                        console.log("No vendor found with the provided email");
                        $('.button-container').hide();
                    }
                },
                error: function (vendorXhr, vendorTextStatus, vendorErrorThrown) {
                    console.error("Error fetching vendor data:", vendorErrorThrown);
                    $('.button-container').hide();
                }
            });
        } else {
            console.error("No email provided in the URL");
            $('.button-container').hide();
        }
    }

    function handleDecline(event) {
        event.preventDefault();
        openDeclinePopup();
    }

    function openDeclinePopup() {
        $('#declinePopup').addClass('open');
        $('#overlay').addClass('open');
    }

    function closeDeclinePopup() {
        $('#declinePopup').removeClass('open');
        $('#overlay').removeClass('open');
    }

    function confirmDecline() {
        var comment = $('#declineComment').val();
        if (!comment.trim()) {
            alert("Please provide a reason for declining.");
            return;
        }
        closeDeclinePopup();
        updateContactWithDeclineComment(comment);
    }
    function handledelete(event) {
        event.preventDefault();
        openDeletePopup();
    }

    function openDeletePopup() {
        $('#deletePopup').addClass('open');
        $('overlay').addClass('open')
    }
    function closeDeletePopup(){
        $('#deletePopup').removeClass('open');
        $('overlay').removeClass('open')
    }
    function handledelete(event) {
    event.preventDefault();
    openDeletePopup();
}

function confirmdelete() {
    var urlParams = new URLSearchParams(window.location.search);
    var email = urlParams.get('email');

    if (!email) {
        console.error("No email provided in the URL");
        alert("Error: Unable to identify the contact. Please try again.");
        return;
    }

    webapi.safeAjax({
        type: "GET",
        url: `/_api/contacts?$filter=emailaddress1 eq '${encodeURIComponent(email)}'`,
        contentType: "application/json",
        success: function(data) {
            if (data && data.value && data.value.length > 0) {
                var contactId = data.value[0].contactid;
                webapi.safeAjax({
                    type: "DELETE",
                    url: `/_api/contacts(${contactId})`,
                    contentType: "application/json",
                    success: function (data, textStatus, xhr) {
                        console.log("Record deleted successfully");
                        closeDeletePopup();
                        openThankYouPopup("The vendor application has been deleted successfully.");
                        $('.delete-btn').hide(); // Hide the delete button after successful deletion
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.error("Error deleting contact:", errorThrown);
                        alert("Error: Unable to delete the contact. Please try again.");
                    }
                });
            } else {
                console.error("No contact found with the provided email during the Delete process");
                alert("Error: Unable to find the contact during the delete process. Please try again.");
            }
        },
        error: function(xhr, textStatus, errorThrown) {
            console.error("Error fetching contact:", errorThrown);
            alert("Error: Unable to fetch contact information. Please try again.");
        }
    });
}
    function updateContactWithDeclineComment(comment) {
        var urlParams = new URLSearchParams(window.location.search);
        var email = urlParams.get('email');

        if (!email) {
            console.error("No email provided in the URL");
            alert("Error: Unable to identify the contact. Please try again.");
            return;
        }

        webapi.safeAjax({
            type: "GET",
            url: `/_api/contacts?$filter=emailaddress1 eq '${email}'`,
            contentType: "application/json",
            success: function(data) {
                if (data && data.value && data.value.length > 0) {
                    var contactId = data.value[0].contactid;
                    updateContactRecord(contactId, comment);
                } else {
                    console.error("No contact found with the provided email");
                    alert("Error: Unable to find the contact. Please try again.");
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                console.error("Error fetching contact:", errorThrown);
                alert("Error: Unable to fetch contact information. Please try again.");
            }
        });
    }

    function updateContactRecord(contactId, comment) {
    webapi.safeAjax({
        type: "GET",
        url: `/_api/contacts(${contactId})`,
        contentType: "application/json",
        success: function(data) {
            var currentStatus = data.crb7c_statuscode;
            var record = {
                crb7c_approvalcomment: comment,
                crb7c_statuscode: 'Declined',
                crb7c_statuscode_record: currentStatus // Store the current status
            };

            webapi.safeAjax({
                type: "PATCH",
                contentType: "application/json",
                url: `/_api/contacts(${contactId})`,
                data: JSON.stringify(record),
                success: function (data, textStatus, xhr) {
                    console.log("Contact record updated with decline comment and status stored");
                    updateApprovalFlow('Declined');
                    openThankYouPopup("The vendor application has been declined.");
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error("Error updating contact record:", errorThrown);
                    alert("Error: Unable to save the decline comment. Please try again.");
                }
            });
        },
        error: function(xhr, textStatus, errorThrown) {
            console.error("Error fetching current status:", errorThrown);
            alert("Error: Unable to fetch current status. Please try again.");
        }
    });
}

$(document).ready(function() {
    var currentVendorId;
    var requiresCFOApproval = false;
    
    function fetchVendorData(email) {
        console.log("Fetching vendor data for email:", email);
        webapi.safeAjax({
            type: "GET",
            url: `/_api/contacts?$filter=emailaddress1 eq '${encodeURIComponent(email)}'`,
            contentType: "application/json",
            headers: {
                "Prefer": "odata.include-annotations=*"
            },
            success: function (data, textStatus, xhr) {
                console.log("Vendor data received:", data);
                if (data && data.value && data.value.length > 0) {
                    var vendor = data.value[0];
                    requiresCFOApproval = ['20 EOM'].includes(vendor.crb7c_paymentterms);
                    
                    // Handle region-specific fields based on description
                    const description = vendor.description;
                    if (description === 'Australia') {
                        $('.nz-field').addClass('hidden').find('input').prop('required', false);
                        $('.au-field').removeClass('hidden').find('input').prop('required', true);
                        $('.overseas-field').addClass('hidden').find('input').prop('required', false);
                        $('#au-field-banking').removeClass('hidden');
                        $('#nz-field-banking').addClass('hidden');
                        $('#overseas-banking').addClass('hidden');
                    } else if (description === 'New Zealand') {
                        $('.au-field').addClass('hidden').find('input').prop('required', false);
                        $('.nz-field').removeClass('hidden').find('input').prop('required', true);
                        $('.overseas-field').addClass('hidden').find('input').prop('required', false);
                        $('#au-field-banking').addClass('hidden');
                        $('#nz-field-banking').removeClass('hidden');
                        $('#overseas-banking').addClass('hidden');
                    } else if (description === 'Overseas') {
                        $('.au-field').addClass('hidden').find('input').prop('required', false);
                        $('.nz-field').addClass('hidden').find('input').prop('required', false);
                        $('.overseas-field').removeClass('hidden');
                        $('#au-field-banking').addClass('hidden');
                        $('#nz-field-banking').addClass('hidden');
                        $('#overseas-banking').removeClass('hidden');
                    }

                    if (vendor.crb7c_parentvendor) {
                        // If parent vendor exists, fetch parent vendor data
                        webapi.safeAjax({
                            type: "GET",
                            url: `/_api/contacts?$filter=emailaddress1 eq '${encodeURIComponent(vendor.crb7c_parentvendor)}'`,
                            contentType: "application/json",
                            headers: {
                                "Prefer": "odata.include-annotations=*"
                            },
                            success: function (parentData, parentTextStatus, parentXhr) {
                                if (parentData && parentData.value && parentData.value.length > 0) {
                                    var parentVendor = parentData.value[0];
                                    // Use parent vendor data for supplier form and vendor data for form
                                    populate_supplierformfields(parentVendor);
                                    populateFormFields(vendor);
                                    updateApprovalFlow(vendor.crb7c_statuscode);
                                } else {
                                    console.error("No parent vendor found with email:", vendor.crb7c_parentvendor);
                                    alert("Error: Parent vendor not found.");
                                }
                            },
                            error: function (parentXhr, parentTextStatus, parentErrorThrown) {
                                console.error("Error fetching parent vendor data:", parentErrorThrown);
                                alert("Error fetching parent vendor data. Please try again later.");
                            }
                        });
                    } else {
                        // If no parent vendor, use the same vendor data for both forms
                        populate_supplierformfields(vendor);
                        populateFormFields(vendor);
                        updateApprovalFlow(vendor.crb7c_statuscode);
                    }
                } else {
                    console.error("No vendor found with the provided email:", email);
                    alert("No vendor found with the provided email.");
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                console.error("Error fetching vendor data:", errorThrown);
                alert("Error fetching vendor data. Please try again later.");
            }
        });
    }

    // Initialize form
    var urlParams = new URLSearchParams(window.location.search);
    var email = urlParams.get('email');

    if (email) {
        console.log("Email found in URL:", email);
        fetchVendorData(email);
    } else {
        console.error("No email provided in the URL");
        alert("No email provided in the URL.");
    }


    // Add validation functions for banking details
    function validateBSB(input) {
        if (!input) return false;
        
        const value = input.value.replace(/\D/g, '');
        input.value = value;
        const errorElement = document.getElementById(input.id + '-error');
        
        if (!errorElement) return false;
        
        if (value.length === 0) {
            input.classList.remove('input-success');
            input.classList.add('input-error');
            errorElement.textContent = 'BSB is required and must be in numerical format.';
            errorElement.style.display = 'block';
            errorElement.className = 'error-message';
            return false;
        } else if (value.length !== 6) {
            input.classList.remove('input-success');
            input.classList.add('input-error');
            errorElement.textContent = 'BSB must be exactly 6 digits.';
            errorElement.style.display = 'block';
            errorElement.className = 'error-message';
            return false;
        } else {
            input.classList.remove('input-error');
            input.classList.add('input-success');
            errorElement.textContent = '';
            errorElement.style.display = 'block';
            errorElement.className = 'success-message';
            return true;
        }
    }

    function validateAccount(input) {
        if (!input) return false;
        
        const value = input.value.replace(/\D/g, '');
        input.value = value;
        const errorElement = document.getElementById(input.id + '-error');
        
        if (!errorElement) return false;
        
        if (value.length === 0) {
            input.classList.remove('input-success');
            input.classList.add('input-error');
            errorElement.textContent = 'Account number is required and must be in numerical format.';
            errorElement.style.display = 'block';
            return false;
        } else if (value.length !== 10) {
            input.classList.remove('input-success');
            input.classList.add('input-error');
            errorElement.textContent = 'Account must be exactly 10 digits.';
            errorElement.style.display = 'block';
            return false;
        } else {
            input.classList.remove('input-error');
            input.classList.add('input-success');
            errorElement.textContent = '';
            errorElement.style.display = 'block';
            errorElement.className = 'success-message';
            return true;
        }
    }

    function validateNumericField(input, fieldName) {
        if (!input) return false;
        
        const value = input.value.replace(/\D/g, '');
        input.value = value;
        
        let errorElement = document.getElementById(input.id + '-error');
        if (!errorElement) {
            errorElement = document.createElement('div');
            errorElement.id = input.id + '-error';
            errorElement.className = 'error-message';
            input.parentNode.insertBefore(errorElement, input.nextSibling);
        }
        
        if (value.length === 0) {
            input.classList.remove('input-success');
            input.classList.add('input-error');
            errorElement.textContent = `${fieldName} must be in numerical format.`;
            errorElement.style.display = 'block';
            return false;
        } else {
            input.classList.remove('input-error');
            input.classList.add('input-success');
            errorElement.textContent = '';
            errorElement.style.display = 'none';
            return true;
        }
    }

    function validateIBAN(input) {
        if (!input) return false;
        
        let errorElement = document.getElementById(input.id + '-error');
        if (!errorElement) {
            errorElement = document.createElement('div');
            errorElement.id = input.id + '-error';
            errorElement.className = 'error-message';
            input.parentNode.insertBefore(errorElement, input.nextSibling);
        }
        
        const value = input.value.replace(/\s/g, '').toUpperCase();
        const ibanRegex = /^[A-Z]{2}[0-9A-Z]{32}$/;
        
        if (value.length === 0) {
            input.classList.remove('input-success');
            input.classList.add('input-error');
            errorElement.textContent = 'IBAN is required.';
            errorElement.style.display = 'block';
            return false;
        } else if (value.length !== 34) {
            input.classList.remove('input-success');
            input.classList.add('input-error');
            errorElement.textContent = 'IBAN must be exactly 34 characters.';
            errorElement.style.display = 'block';
            return false;
        } else if (!ibanRegex.test(value)) {
            input.classList.remove('input-success');
            input.classList.add('input-error');
            errorElement.textContent = 'Invalid IBAN format. Must start with 2 letters followed by 32 characters.';
            errorElement.style.display = 'block';
            return false;
        } else {
            input.classList.remove('input-error');
            input.classList.add('input-success');
            errorElement.textContent = '';
            errorElement.style.display = 'none';
            input.value = value.match(/.{1,4}/g).join(' ');
            return true;
        }
    }

    // Add event listeners for validation
    document.querySelectorAll('#bsb, #nz_BSB').forEach(input => {
        if (input) {
            input.addEventListener('input', () => validateBSB(input));
            input.addEventListener('blur', () => validateBSB(input));
        }
    });

    document.querySelectorAll('#account, #nz_account').forEach(input => {
        if (input) {
            input.addEventListener('input', () => validateAccount(input));
            input.addEventListener('blur', () => validateAccount(input));
        }
    });

    // Initialize form
    $(document).ready(function() {
        var urlParams = new URLSearchParams(window.location.search);
        var email = urlParams.get('email');

        if (email) {
            console.log("Email found in URL:", email);
            fetchVendorData(email);
        } else {
            console.error("No email provided in the URL");
            alert("No email provided in the URL.");
        }
    });

    // Rest of your existing code remains the same...
});
    </script>
</body>
</html>

