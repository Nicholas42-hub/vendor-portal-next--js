<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approvers Matrix</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
      body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          background-color: #f4f4f4;
      }
      .approver-form-container {
          max-width: 500px;
          margin: 20px auto;
          background-color: #fff;
          padding: 30px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h2 {
          font-size: 24px;
          color: #333;
          margin-bottom: 20px;
          /* Removed text-align: left; to prevent overriding */
      }
      .approver-form-container h2 {
          text-align: left; /* Keep the form heading left-aligned */
      }
      .form-section {
          margin-bottom: 30px;
          border: 1px solid #ddd;
          padding: 20px;
          border-radius: 5px;
      }
      .form-section h3 {
          margin-top: 0;
          margin-bottom: 15px;
          font-size: 18px;
          color: #444;
      }
      .form-group {
          margin-bottom: 20px;
      }
      label {
          display: block;
          margin-bottom: 5px;
          color: #555;
          font-weight: bold;
      }
      select {
          width: 100%;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
      }
      .btn-save {
          width: 100%;
          padding: 12px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
          transition: background-color 0.3s ease;
      }
      .btn-save:hover {
          background-color: #45a049;
      }
      .popup {
          display: none;
          width: 90%;
          max-width: 400px;
          padding: 20px;
          background-color: white;
          border-radius: 10px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          text-align: center;
          position: fixed;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          z-index: 1000;
      }
      .popup.open {
          display: block;
      }
      .popup-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 999;
      }
      .popup-overlay.open {
          display: block;
      }
      .button-container {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-top: 20px;
      }
      .popup button {
          width: 100px;
          padding: 10px;
          color: white;
          border: none;
          border-radius: 5px;
          font-size: 16px;
          cursor: pointer;
      }

      .popup button.btn-yes {
          background-color: #4CAF50;
      }

      .popup button.btn-no {
          background-color: #FF0000;
      }
      /* Add this CSS rule to center the content inside the popup */
      .popup h2,
      .popup p {
          text-align: center;
      }
  </style>
</head>
<body>
    <div class="approver-form-container">
        <h2>Approvers Matrix</h2>
        <form id="approverForm">
            <!-- Section 1: Business Unit and Approver 1 -->
            <div class="form-section">
                <h3>Manager Approvers</h3>
                <div class="form-group">
                    <label for="businessUnit">Business Unit:</label>
                    <select id="businessUnit" name="Business Unit:">
                        <option value="" disabled selected>Select an option</option>
                        <option value="Duty Free">Duty Free</option>
                        <option value="Food Services">Food Services</option>
                        <option value="Specialty">Specialty</option>
                        <option value="Travel Essentials">Travel Essentials</option>
                        <option value="Finance">Finance</option>
                        <option value="IT">IT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="approver1">Manager Approver:</label>
                    <select id="approver1" name="approver1"></select>
                </div>
                <div class="form-group">
                    <label for="approver1backup">Manager Approver 2:</label>
                    <select id="approver1backup" name="approver1backup"></select>
                </div>
            </div>
 
            <!-- Section 2: CFO Approvers -->
            <div class="form-section">
                <h3>CFO Approvers  (for payment terms below 30 days)</h3>
                <div class="form-group">
                    <label for="approver2">CFO Approver:</label>
                    <select id="approver2" name="approver2"></select>
                </div>
                <div class="form-group">
                    <label for="approver2backup">CFO Approver Replacement:</label>
                    <select id="approver2backup" name="approver2backup"></select>
                </div>
            </div>
 
            <!-- Section 3: Exco Member Approvers -->
            <div class="form-section">
                <h3>Exco Member Approvers</h3>
                <div class="form-group">
                    <label for="approver3">Exco Member Approver:</label>
                    <select id="approver3" name="approver3"></select>
                </div>
                <div class="form-group">
                    <label for="approver3backup">Exco Member Approver 2:</label>
                    <select id="approver3backup" name="approver3backup"></select>
                </div>
            </div>
 
            <button type="submit" class="btn-save">Save Approvers</button>
        </form>
    </div>
 
    <!-- Confirm Popup -->
    <div id="confirmPopup" class="popup">
        <h2>Would you like to proceed?</h2>
        <div class="button-container">
            <button type="button" class="btn-yes" onclick="proceedSubmit()">Yes</button>
            <button type="button" class="btn-no"  onclick="closeConfirmPopup()">No</button>
        </div>
    </div>
 
    <!-- Thank You Popup -->
    <div id="thankYouPopup" class="popup">
        <h2>Thank you!</h2>
        <p>Your form has been successfully submitted. Thanks!</p>
        <button type="button" onclick="closeThankYouPopup()">OK</button>
    </div>
 
    <div id="overlay" class="popup-overlay"></div>
 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
      (function(webapi, $){
  function safeAjax(ajaxOptions) {
      var deferredAjax = $.Deferred();
      shell.getTokenDeferred().done(function (token) {
          if (!ajaxOptions.headers) {
              ajaxOptions.headers = {};
          }
          ajaxOptions.headers["Authorization"] = "Bearer " + token;
          $.ajax(ajaxOptions)
              .done(deferredAjax.resolve)
              .fail(deferredAjax.reject);
      }).fail(function (error) {
          console.error("Error obtaining token:", error);
          deferredAjax.rejectWith(this, arguments);
      });
      return deferredAjax.promise();
  }
  webapi.safeAjax = safeAjax;
})(window.webapi = window.webapi || {}, jQuery);

// Mapping table of business units to approversesid
const businessUnitIdMap = {
  "Duty Free": "0e77799b-dbea-43a5-9583-ef630753cf8b",
  "Food Services": "bd5ba99c-3697-4f5d-97e5-72c232394106",
  "Specialty": "dcbf60bc-6bfc-44ee-a3d3-877f52144e9e",
  "Travel Essentials": "930dc67f-f921-48ad-a0c1-741c1200f751",
  'Finance': '6033d111-9878-ef11-ac20-00224891e3e1',
  'IT': '76dc8932-0887-ef11-ac20-00224894b1b5'
};

$(document).ready(function() {
  // Initialize select2 for all dropdowns
  $('select').select2({
      placeholder: "Select an option",
      allowClear: true
  });

  // Fetch contacts and populate dropdowns
  fetchContacts().then(contacts => {
      populateApproversDropdowns(contacts);

      $('#businessUnit').on('change', function() {
          populateApprover1(contacts, $(this).val());
      });
  }).catch(error => {
      console.error("Failed to fetch contacts:", error);
  });

  $('#approverForm').on('submit', function(event) {
      event.preventDefault();
      showConfirmPopup();
  });
});

function showConfirmPopup() {
  $('#confirmPopup, #overlay').addClass('open');
}

function closeConfirmPopup() {
  $('#confirmPopup, #overlay').removeClass('open');
}

function proceedSubmit() {
  closeConfirmPopup();
  submitForm();
}

function submitForm() {
  const businessUnit = $('#businessUnit').val();
  const approver1 = $('#approver1').val();
  const approver1backup = $('#approver1backup').val();
  const approver2 = $('#approver2').val();
  const approver2backup = $('#approver2backup').val();
  const approver3 = $('#approver3').val();
  const approver3backup = $('#approver3backup').val();

  // Check if at least one approver field has been selected
  if (!businessUnit && !approver1 && !approver1backup && !approver2 && !approver2backup && !approver3 && !approver3backup) {
      alert("Please select at least one approver to update.");
      return;
  }

  let updatePromises = [];

  if (businessUnit) {
      // Update for the specific business unit
      const approversesid = businessUnitIdMap[businessUnit];
      if (!approversesid) {
          alert("Invalid business unit selected.");
          return;
      }
      let updateData = {};

      // Build updateData dynamically based on selected fields
      if (approver1) updateData.crb7c_approver1 = approver1;
      if (approver1backup) updateData.crb7c_approver1backup = approver1backup;
      if (approver2) updateData.crb7c_approver2 = approver2;
      if (approver2backup) updateData.crb7c_approver2backup = approver2backup;
      if (approver3) updateData.crb7c_approver3 = approver3;
      if (approver3backup) updateData.crb7c_approver3backup = approver3backup;

      if (Object.keys(updateData).length === 0) {
          alert("Please select at least one approver to update.");
          return;
      }

      updatePromises.push(updateApprovers(approversesid, updateData));
  } else {
      // Update all business units for selected approvers
      let updateDataTemplate = {};

      if (approver2) updateDataTemplate.crb7c_approver2 = approver2;
      if (approver2backup) updateDataTemplate.crb7c_approver2backup = approver2backup;
      if (approver3) updateDataTemplate.crb7c_approver3 = approver3;
      if (approver3backup) updateDataTemplate.crb7c_approver3backup = approver3backup;

      if (Object.keys(updateDataTemplate).length === 0) {
          alert("Please select at least one approver to update.");
          return;
      }

      Object.values(businessUnitIdMap).forEach(approversesid => {
          let updateData = Object.assign({}, updateDataTemplate);
          updatePromises.push(updateApprovers(approversesid, updateData));
      });
  }

  Promise.all(updatePromises)
      .then(() => {
          showThankYouPopup();
          resetForm();
      })
      .catch(error => {
          console.error("Error updating approvers:", error);
          alert("Error updating approvers: " + error.message);
      });
}

function updateApprovers(approversesid, updateData) {
  return new Promise((resolve, reject) => {
      webapi.safeAjax({
          type: "PATCH",
          url: `/_api/crb7c_approverses(${approversesid})`,
          contentType: "application/json",
          data: JSON.stringify(updateData),
          success: function(data, textStatus, xhr) {
              resolve();
          },
          error: function(xhr, textStatus, errorThrown) {
              reject(new Error(xhr.responseJSON?.error?.message || xhr.responseText || "Unknown error"));
          }
      });
  });
}

function showThankYouPopup() {
  $('#thankYouPopup, #overlay').addClass('open');
}

function closeThankYouPopup() {
  $('#thankYouPopup, #overlay').removeClass('open');
}

function resetForm() {
  $('#approverForm')[0].reset();
  $('select').val(null).trigger('change');
}

function fetchContacts() {
  return new Promise((resolve, reject) => {
      webapi.safeAjax({
          type: "GET",
          url: "/_api/contacts?$select=emailaddress1,lastname,jobtitle",
          contentType: "application/json",
          headers: {
              "Prefer": "odata.include-annotations=*"
          },
          success: function (data, textStatus, xhr) {
              console.log("Contacts fetched successfully:", data);
              resolve(data.value);
          },
          error: function (xhr, textStatus, errorThrown) {
              console.error("Error fetching contacts:", errorThrown);
              reject(errorThrown);
          }
      });
  });
}

function populateApproversDropdowns(contacts) {
  // CFO Approvers
  const cfoApprovers = contacts.filter(contact => 
      ['Nik WEST', 'Alfonso LOPEZ'].includes(contact.lastname)
  );
  populateDropdown('#approver2, #approver2backup', cfoApprovers);

  // Finance Approvers
  const financeApprovers = contacts.filter(contact => 
      ['Alfonso LOPEZ', 'Tom RYAN'].includes(contact.lastname)
  );
  populateDropdown('#approver1, #approver1backup', financeApprovers);

  // Exco Members
  const excoMembers = contacts.filter(contact => 
      ['Stav VAFEAS', 'Costa KOUROS', 'Chris LAVERTY', 'Francine BALESTRIERI', 'Nik WEST', 'Shane MINORS'].includes(contact.lastname)
  );
  populateDropdown('#approver3, #approver3backup', excoMembers);
}

function populateApprover1(contacts, selectedBusinessUnit) {
  let approver1Contacts;
  switch(selectedBusinessUnit) {
      case 'IT':
          approver1Contacts = contacts.filter(contact => contact.lastname === 'Shaun STANYER');
          break;
      case 'Food Services':
          approver1Contacts = contacts.filter(contact => ['Anne STEER', 'Navdeep KAUR'].includes(contact.lastname));
          break;
      case 'Specialty':
          approver1Contacts = contacts.filter(contact => contact.lastname === 'Voula DIMOPOULOS');
          break;
      case 'Travel Essentials':
          approver1Contacts = contacts.filter(contact => contact.lastname === 'Sean THOMAS');
          break;
      case 'Duty Free':
          approver1Contacts = contacts.filter(contact => ['FwuWren LOH', 'Vanita NAND'].includes(contact.lastname));
          break;
      case 'Finance':
          approver1Contacts = contacts.filter(contact => ['Alfonso LOPEZ', 'Tom RYAN'].includes(contact.lastname));
          break;
      default:
          approver1Contacts = [];
  }
  populateDropdown('#approver1, #approver1backup', approver1Contacts);
}

function populateDropdown(selector, contacts) {
  const dropdown = $(selector);
  dropdown.empty();
  dropdown.append('<option></option>');

  contacts.forEach(contact => {
      if (contact.emailaddress1 && contact.lastname) {
          dropdown.append(`<option value="${contact.emailaddress1}">${contact.lastname} - ${contact.jobtitle} (${contact.emailaddress1})</option>`);
      }
  });

  dropdown.trigger('change');
}
    </script>
</body>
</html>

<div class="row sectionBlockLayout text-left" style="display: flex; flex-wrap: wrap; margin: 0px; min-height: auto; padding: 8px;">
  <div class="container" style="padding: 0px; display: flex; flex-wrap: wrap;"><div class="col-md-12 columnBlockLayout" style="flex-grow: 1; display: flex; flex-direction: column; min-width: 250px; word-break: break-word;"></div></div>
</div>
